workflows:
  version: 2
  main:
    jobs:
      - php73-lint
      - php73-core-tests
      - php73-core-tests-mu-plugins
      - php73-build-multisite
      - php73-build-singlesite
      - php74-lint
      - php74-build-multisite
      - php74-build-singlesite
      - php74-build-multisite-nightly
      - php74-build-singlesite-nightly

version: 2.1

parameters:
  wp_test_dir:
    type: string
    default: /tmp/wordpress-tests-lib
  wp_core_dir:
    type: string
    default: /tmp/wordpress/
  wp_core_develop_dir:
    type: string
    default: /tmp/wordpress-develop
  db_host:
    type: string
    default: 127.0.0.1
  db_name:
    type: string
    default: wordpress_test
  db_user:
    type: string
    default: root
  db_pass:
    type: string
    default: ""


job-references:
  db_image: &db_image
    circleci/mariadb:10.2

  setup_environment: &setup_environment
    name: "Setup Environment Variables"
    command: |
      echo "export PATH=$HOME/.composer/vendor/bin:$PATH" >> $BASH_ENV
      source /home/circleci/.bashrc

  install_dependencies: &install_dependencies
    name: "Install Dependencies"
    command: |
      sudo apt-get update && sudo apt-get install subversion libgcc-8-dev default-mysql-client
      sudo -E docker-php-ext-install mysqli
      npm ci
      composer install -n
  
  install_core_tests_dependencies: &install_core_tests_dependencies
    name: "Install Dependencies"
    command: |
      sudo apt-get update && sudo apt-get -y install subversion libgcc-8-dev default-mysql-client nodejs npm
      sudo npm install npm@latest -g
      composer install -n

  prepare_repo: &prepare_repo
    name: "Prepare Repo"
    command: |
      git submodule update --init --recursive

  php_job: &php_job
    steps:
      - checkout
      - run: *setup_environment
      - run: *install_dependencies
      - run: *prepare_repo
      - run:
          name: "Run Tests"
          command: |
            rm -rf << pipeline.parameters.wp_core_dir >> << pipeline.parameters.wp_test_dir >>
            bash bin/install-wp-tests.sh << pipeline.parameters.db_name >> << pipeline.parameters.db_user >> "<< pipeline.parameters.db_pass>>"  << pipeline.parameters.db_host >> "$WP_VERSION"
            vendor/bin/phpunit --version
            vendor/bin/phpunit

  php_core_job: &php_core_job
    steps:
      - checkout
      - run: *install_core_tests_dependencies
      - run: *prepare_repo
      - run:
          name: "Run Tests"
          command: |
            rm -rf << pipeline.parameters.wp_core_develop_dir >>
            bash bin/install-wp-develop.sh << pipeline.parameters.db_name >> << pipeline.parameters.db_user >> "<< pipeline.parameters.db_pass>>"  << pipeline.parameters.db_host >> "$WP_VERSION"
            cd << pipeline.parameters.wp_core_develop_dir >>
            npm ci
            npm run build
            export WP_TESTS_DIR=<< pipeline.parameters.wp_core_develop_dir >>/tests/phpunit
            if [[ "$INCLUDE_MU_TESTS" == "1" ]]; then
              cp -r $HOME/project/ build/wp-content/mu-plugins
              rm -rf tests/phpunit/data/plugins/wordpress-importer

              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/filesystem/findFolder.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/user/capabilities.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/term/wpGetObjectTerms.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/term/getTheTerms.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/term/getTerm.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/term/wpGetObjectTerms</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/sitemaps/sitemaps.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/sitemaps/functions.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/rest-api/rest-schema-setup.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/term/cache.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/query/search.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/privacy/wpPrivacySendRequestConfirmationNotification.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/privacy/wpPrivacySendPersonalDataExportEmail.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/post/getLastPostModified.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/feed/rss2.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/mail.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/dbdelta.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/date/getFeedBuildDate.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/comment/wpCountComments.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/includes/testcase-canonical.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getProfile.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getPosts.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/phpunit/tests/xmlrpc/wp/getPostTypes.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/user/wpSendUserRequest.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/rest-api/rest-attachments-controller.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/canonical/sitemaps.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/phpunit/tests/xmlrpc/wp/restoreRevision.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/newTerm.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/newPost.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getUsers.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/restoreRevision.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getUser.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getTerms.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getTaxonomy.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getRevisions.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getPostTypes.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getPost.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getPages.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getTerm.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getPostType.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getPageList.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getPage.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getOptions.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getMediaItem.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getComments.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/editTerm.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/editProfile.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/editPost.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/deleteTerm.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/deletePost.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/mw/newPost.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/mw/getRecentPosts.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/mw/getPost.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/mw/editPost.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/feed/atom.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getTaxonomies.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/wp/getComment.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/mt/getRecentPostTitles.php</exclude>" phpunit.xml.dist
              sed -i "/<testsuite name=\"default\">/a <exclude>tests/phpunit/tests/xmlrpc/basic.php</exclude>" phpunit.xml.dist
            fi
            $HOME/project/vendor/bin/phpunit


  lint_job: &lint_job
    steps:
      - checkout
      - run: *prepare_repo
      - run: npm ci
      - run: composer install -n
      - run: 
          name: "Lint"
          command: npm run lint

jobs:
  php73-lint:
    <<: *lint_job
    docker:
      - image: circleci/php:7.3-node

  php73-core-tests:
    <<: *php_core_job
    environment:
      - WP_MULTISITE: "0"
      - WP_VERSION: "latest"
    docker:
      - image: wordpressdevelop/php:7.3-fpm
      - image: *db_image

  php73-core-tests-mu-plugins:
    <<: *php_core_job
    environment:
      - INCLUDE_MU_TESTS: "1"
      - WP_MULTISITE: "0"
      - WP_VERSION: "latest"
    docker:
      - image: wordpressdevelop/php:7.3-fpm
      - image: *db_image

  php73-build-multisite:
    <<: *php_job
    environment:
      - WP_MULTISITE: "1"
      - WP_VERSION: "latest"
    docker:
      - image: circleci/php:7.3-node
      - image: *db_image

  php73-build-singlesite:
    <<: *php_job
    environment:
      - WP_MULTISITE: "0"
      - WP_VERSION: "latest"
    docker:
      - image: circleci/php:7.3-node
      - image: *db_image

  php74-lint:
    <<: *lint_job
    docker:
      - image: circleci/php:7.4-node

  php74-build-multisite:
    <<: *php_job
    environment:
      - WP_MULTISITE: "1"
      - WP_VERSION: "latest"
    docker:
      - image: circleci/php:7.4-node
      - image: *db_image

  php74-build-singlesite:
    <<: *php_job
    environment:
      - WP_MULTISITE: "0"
      - WP_VERSION: "latest"
    docker:
      - image: circleci/php:7.4-node
      - image: *db_image

  php74-build-multisite-nightly:
    <<: *php_job
    environment:
      - WP_MULTISITE: "1"
      - WP_VERSION: "nightly"
    docker:
      - image: circleci/php:7.4-node
      - image: *db_image

  php74-build-singlesite-nightly:
    <<: *php_job
    environment:
      - WP_MULTISITE: "0"
      - WP_VERSION: "nightly"
    docker:
      - image: circleci/php:7.4-node
      - image: *db_image
